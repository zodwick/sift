# Sift — Photo Triage Tool
## Full Specification

---

## 1. Problem Statement

After a trip (e.g., Thailand, 5,000+ photos), a photographer ends up with thousands of
photos from multiple devices. Manually sorting through them is tedious.

Sift is a **reusable local tool** that indexes a directory of photos and provides a fast
keyboard-driven review UI to keep or reject photos. Photos are sorted chronologically so
similar shots naturally appear next to each other.

---

## 2. Core Workflow

```
sift <directory>
    |
    v
[1. Index Scan]        -- Extract EXIF, generate thumbnails
    |
    v
[2. Review UI]         -- Web-based triage interface (auto-opens in browser)
    |                      - Browse all photos sequentially
    |                      - Keyboard-driven keep/reject decisions
    |
    v
[3. Summary & Confirm] -- Show stats, confirm before moving files
    |
    v
[4. Execute]           -- Move rejected photos to _rejected/ folder
```

---

## 3. Sort Order

Photos are sorted **chronologically** by EXIF `DateTimeOriginal` (falling back to file
modification time when EXIF is missing). This naturally places burst shots, retakes, and
cross-device photos of the same scene next to each other, letting the user visually
identify and triage duplicates without algorithmic grouping.

---

## 4. File Handling

### Supported Formats
- **Standard**: JPEG, HEIC/HEIF, PNG, WebP
- **RAW**: CR2, ARW, NEF, DNG (via rawpy/libraw)
- RAW files use their embedded JPEG preview for display

### What Happens to Files
- **Kept photos**: Left in place (original directory untouched)
- **Rejected photos**: Moved to a `_rejected/` subfolder within the source directory
- **Corrupted/unreadable files**: Skipped during indexing, logged to `_errors.log`

### No Conversion
Files are never converted or modified. The tool works with whatever formats exist.

### Video Files
Ignored entirely. This tool processes photos only.

---

## 5. UI Specification

### Platform: Local Web App
- Python backend serves API + static files
- Frontend opens in the user's default browser
- URL also printed to terminal for manual access

### Theme: Dark Mode
Dark background to avoid competing with photo content. No light mode toggle needed.

### Layout: Review Screen

```
+------------------------------------------------------------------+
| Sift                                Photo 42/4847 |  Progress: 1% |
+------------------------------------------------------------------+
|                                                                    |
|  +--------------------------------------------------------------+ |
|  |                                                                | |
|  |                                                                | |
|  |                    Large Preview (current photo)               | |
|  |                                                                | |
|  |                                                                | |
|  +--------------------------------------------------------------+ |
|                                                                    |
|  +--+--+--+--+--+--+--+--+--+--+--+--+--+--+--+--+--+--+--+--+ |
|  |  |  |##|  |  |  |  |  |  |  |  |  |  |  |  |  |  |  |  |  | |
|  +--+--+--+--+--+--+--+--+--+--+--+--+--+--+--+--+--+--+--+--+ |
|                         ^ current                                  |
|                                                                    |
|  EXIF: Canon EOS R5 | 24mm f/2.8 | 2026-01-18 14:32 | 6000x4000 |
|                                                                    |
|  [J] Reject  [K] Keep  [H/L] Prev/Next  [F] Zoom  [?] Help      |
+------------------------------------------------------------------+
```

### Large Preview (Center)
- Shows the current photo at the largest size that fits
- Maintains original aspect ratio (letterboxed on dark background)
- **Toggle zoom**: Press `f` to zoom to 100% crop for sharpness inspection
  - Pan with mouse or arrow keys while zoomed
  - Press `f` again or `Esc` to return to fit-to-view

### Thumbnail Strip (Bottom)
- **Scrollable horizontal filmstrip** showing surrounding photos for context
- Current photo highlighted with a border
- Keep/reject state shown as color overlay on each thumbnail:
  - Green tint = kept
  - Red tint = rejected
  - No tint = undecided
- Clicking a thumbnail jumps to that photo
- Strip auto-scrolls to keep the current photo centered

### EXIF Info Bar
- Displays below the preview: camera model, focal length, date/time, dimensions
- Visible but unobtrusive

---

## 6. Keyboard Shortcuts (Vim-Style)

| Key | Action |
|-----|--------|
| `h` / `Left Arrow` | Previous photo |
| `l` / `Right Arrow` | Next photo |
| `k` | **Keep** the current photo (and advance to next) |
| `j` | **Reject** the current photo (and advance to next) |
| `z` | **Undo** last decision (go back one photo, restore its previous state) |
| `f` | Toggle **full-screen zoom** on current photo |
| `?` | Show keyboard shortcut help overlay |
| `Esc` | Exit zoom / close overlay |

### Decision Flow
- Pressing `k` or `j` marks the photo and automatically advances to the next undecided photo
- Photos default to **undecided** — only explicitly marked photos are affected at execution
- The user can navigate freely with `h`/`l` and revisit any photo to change its decision

### Undo
Pressing `z` steps back to the last photo where a decision was made and clears that decision,
allowing the user to re-evaluate.

---

## 7. Session Persistence

### Default: Full Resume
- All indexing results and triage decisions are saved to a `.sift_session.json` file
  in the source directory
- On relaunch with the same directory, the tool detects the session file and offers:
  - **Resume** — continue where you left off, skip to first undecided photo
  - **Re-index** — re-scan files but preserve previous keep/reject decisions
    (handles added/removed files between sessions)
  - **Start fresh** — ignore previous session entirely

### Session File Contents
- Index data (EXIF, thumbnails path)
- Per-photo keep/reject decisions
- Current position in the review queue

---

## 8. Summary & Confirmation

Before any files are moved, show a summary screen:

```
+------------------------------------------+
|           Triage Summary                  |
+------------------------------------------+
|  Total photos scanned:     4,847         |
|  Photos reviewed:          4,200         |
|  Photos undecided:           647         |
|                                           |
|  Photos kept:              2,891         |
|  Photos rejected:          1,309         |
|  Disk space to free:       14.3 GB       |
|                                           |
|  [Confirm & Move]    [Go Back & Review]  |
+------------------------------------------+
```

The user must explicitly confirm before any files are moved to `_rejected/`.
Undecided photos are left in place (treated as kept).

---

## 9. EXIF Metadata Filtering

The review UI includes filter controls to narrow which photos are shown:

- **By camera model** — e.g., show only photos from "iPhone 15 Pro" vs "Galaxy S24"
- **By date range** — focus on a specific day of the trip
- **By file type** — e.g., show only HEIC, only JPEG, only RAW

Filters apply to the review queue. Filtered-out photos are not affected by triage decisions.

---

## 10. Indexing Progress UI

During the upfront scan, the browser shows:

- **Progress bar** at the top with percentage and file count (e.g., "2,341 / 5,000")
- **Collapsible live log** below showing:
  - Each file being processed
  - Running stats: photos indexed, errors skipped
  - Format breakdown (X JPEG, Y HEIC, Z RAW)

The review UI launches automatically once indexing completes.

---

## 11. Tech Stack

### Backend: Python

| Component | Library | Rationale |
|-----------|---------|-----------|
| Web framework | **FastAPI** | Async, fast, native WebSocket support for real-time progress updates |
| ASGI server | **Uvicorn** | Production-grade, works with FastAPI |
| Image loading | **pyvips** | 10x faster than Pillow for batch thumbnail generation, low memory |
| HEIC support | **pillow-heif** | Enables HEIC/HEIF reading through Pillow/pyvips |
| RAW support | **rawpy** | libraw wrapper, supports CR2/ARW/NEF/DNG |
| EXIF extraction | **exifread** | Native HEIC + RAW support, no C dependencies |
| Concurrency | **multiprocessing** / **asyncio** | Parallel thumbnail generation across CPU cores |

### Frontend

| Component | Choice | Rationale |
|-----------|--------|-----------|
| Framework | **Svelte + Vite** | Minimal boilerplate, reactive state management, tiny bundle, great keyboard event handling |
| Styling | **Tailwind CSS** | Utility-first, easy dark mode, rapid UI development |
| Image display | Native `<img>` + CSS Grid/Flexbox | Lazy loading for thumbnails |
| State management | Svelte stores | Built-in reactivity for undo stack, decision state, filter state |
| WebSocket | Native WebSocket API | Real-time indexing progress updates from backend |

### Data Flow

```
[Filesystem] --> [pyvips thumbnails] --> [/static/thumbs/]
                                              |
[Filesystem] --> [exifread metadata]  --> [JSON session file]
                                              |
                                     [FastAPI REST + WS API]
                                              |
                                     [Svelte Frontend in Browser]
```

---

## 12. API Endpoints (Backend)

```
GET    /api/status              — Indexing progress / session state
GET    /api/photos              — List all photos (sorted chronologically, paginated)
GET    /api/photo/:id/thumb     — Serve thumbnail image
GET    /api/photo/:id/full      — Serve full-resolution image
GET    /api/photo/:id/meta      — Get EXIF metadata for a photo
POST   /api/decision            — Submit keep/reject decision for a photo
POST   /api/undo                — Undo last decision
GET    /api/summary             — Get triage summary stats
POST   /api/execute             — Confirm and execute file moves
GET    /api/filters             — Get available filter values (cameras, dates, types)
WS     /ws/progress             — Real-time indexing progress stream
```

---

## 13. Directory Structure (Project)

```
sift/
  backend/
    main.py                 — FastAPI app entry point
    indexer.py              — Photo scanning, EXIF extraction, thumbnail generation
    session.py              — Session persistence (save/load/resume)
    models.py               — Data models (Photo, Decision)
    api/
      routes.py             — API route definitions
      websocket.py          — WebSocket handlers for progress
  frontend/
    src/
      App.svelte            — Root component
      lib/
        PhotoReview.svelte     — Main review view
        ThumbnailStrip.svelte  — Scrollable filmstrip
        PhotoPreview.svelte    — Large preview with zoom
        ExifBar.svelte         — Metadata display
        Summary.svelte         — Final summary + confirm
        ProgressScreen.svelte  — Indexing progress display
        FilterBar.svelte       — Camera/date/type filters
        KeyboardHelp.svelte    — Shortcut overlay
      stores/
        photos.js            — Photo list + navigation state
        decisions.js         — Keep/reject state + undo stack
        filters.js           — Active filters
      utils/
        keyboard.js          — Keyboard shortcut handler
        websocket.js         — WebSocket connection manager
    vite.config.js
    tailwind.config.js
    package.json
  requirements.txt
  README.md
```

---

## 14. Non-Goals (Explicitly Out of Scope)

- Automatic duplicate/similarity detection or grouping
- Video deduplication or processing
- Cloud sync or remote storage
- AI-powered scene/face recognition
- Batch renaming or file organization beyond keep/reject
- Photo editing (crop, color correction, etc.)
- Mobile app or remote access
- File format conversion
- Multi-user / collaborative review

---

## 15. Performance Targets

| Operation | Target | Notes |
|-----------|--------|-------|
| Index 5,000 photos | Reasonable | EXIF + thumbnails, parallelized across cores |
| Thumbnail generation | ~50-100ms/photo | pyvips streaming architecture |
| UI responsiveness | < 100ms per interaction | Keyboard press to visual update |
| Image serve (thumbnail) | < 50ms | Pre-generated, served from disk |
| Image serve (full-res) | < 500ms | Direct file serve, browser handles rendering |

---

## 16. Error Handling

- **Corrupted files**: Skip, log to `_errors.log`, continue indexing
- **Unsupported formats**: Skip, log, continue
- **Zero-byte files**: Skip, log, continue
- **Permission errors**: Log warning, skip file
- **Disk full during move**: Abort remaining moves, report which files were and weren't moved
- **Browser disconnected**: Session state is persisted server-side; reconnecting resumes

---

## 17. Future Considerations (Not for v1)

These are explicitly deferred but noted for potential future versions:
- Automatic similarity grouping (perceptual hashing, time-based clustering)
- GPS/location-based grouping and map view
- Face detection for people-based grouping
- Sharpness/quality auto-ranking within similar photos
- Export report (CSV/JSON of all decisions)
- Side-by-side comparison mode


i would like to use uv for backend and bun for frontend package managements